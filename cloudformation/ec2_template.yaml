Parameters:
  
  MainVPC:
    Type: String
  ImportedKeyPair:
    Type: String
  InstanceProfileArn:
    Type: String
  PrivateInstanceSecurityGroup:
    Type: String
  WebServerSecurityGroup:
    Type: String
  DBUsernameParameter:
    Type: String
  DBPasswordParameter:
    Type: String
  DatabaseEndpoint:
    Type: String

Resources:

  LaunchTemplateEc2Micro:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub ${AWS::StackName}-launch-template
      LaunchTemplateData:
        ImageId: ami-052064a798f08f0d3
        InstanceType: t3.micro
        KeyName: !Ref ImportedKeyPair
        IamInstanceProfile: 
          Arn: !Ref InstanceProfileArn

        SecurityGroupIds:
          - !Ref WebServerSecurityGroup
          - !Ref PrivateInstanceSecurityGroup  # Add this to allow SSH from bastion hosts

        UserData:
          Fn::Base64: 
            !Sub |
              #!/bin/bash
            
              DB_USER=${DBUsernameParameter}
              DB_PASS="${DBPasswordParameter}"
              DB_ENDPOINT="${DatabaseEndpoint}";
              echo "Using DB_USER=$DB_USER" >> /var/log/init.log 
              #port 3000

              yum update -y
              yum install -y awscli mariadb105 httpd unzip git

              sudo yum install docker -y

              sudo systemctl start docker
              sudo systemctl enable docker

              sudo usermod -a -G docker ec2-user

              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose

              git clone https://github.com/danielarell/speedcola.git

              git clone https://github.com/danielarell/Frontend_SpeedCola /var/www/html/
              echo '<!DOCTYPE html><html><head><title>Health Check</title></head><body>OK</body></html>' > /var/www/html/health.html
              echo "DB_USER=$DB_USER\nDB_HOST=$DB_ENDPOINT\nDB_PASSWORD=$DB_PASS" > /var/www/html/.env
              echo "CREATE DATABASE facturas;" |  mysql -h $DB_ENDPOINT -u "$DB_USER" -p"$DB_PASS" ;

              #docker-compose up -d --build


              
            

              chown -R apache:apache /var/www/html/
              chmod -R 755 /var/www/html/

              systemctl restart httpd
        TagSpecifications:
        - ResourceType: instance
          Tags:
          - Key: environment
            Value: development
        - ResourceType: volume
          Tags:
          - Key: environment
            Value: development



Outputs:
  LaunchTemplateEc2Micro:
    Value: !Ref LaunchTemplateEc2Micro
