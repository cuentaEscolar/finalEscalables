Parameters:
  PublicKey:
    Type: String
Resources:

  ImportedKeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: "public_key_2"  # Nombre del key pair en AWS
      PublicKeyMaterial: !Ref PublicKey
      Tags:
        - Key: Name
          Value: "public_key_2"

  
  DBSecret:
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: !Sub ${AWS::StackName}-db-credentials
        GenerateSecretString:
          SecretStringTemplate: '{"username": "admin"}'
          GenerateStringKey: "password"
          PasswordLength: 16
          ExcludeCharacters: "'\"@\\!/" 

  DBUsernameParameter:
    Type: AWS::SSM::Parameter
    DependsOn: DBSecret
    Properties:
      Name: "/myapp/db/username"
      Type: String
      Value: !Sub "{{resolve:secretsmanager:${DBSecret}::username}}"

  DBPasswordParameter:
    Type: AWS::SSM::Parameter
    DependsOn: DBSecret
    Properties:
      Name: "/myapp/db/password"
      Type: String
      Value: !Sub "{{resolve:secretsmanager:${DBSecret}::password}}"

Outputs:
  DBSecret:
    Value: !Ref DBSecret

  DBPasswordParameter:
    Value: !Ref DBPasswordParameter

  DBUsernameParameter:
    Value: !Ref DBUsernameParameter

  ImportedKeyPair:
    Value: !Ref ImportedKeyPair
